# 🚨 装甲车辆评估软件 - 程序无响应排查指南

> 当双击程序没有反应时的完整解决方案

## 🎯 问题现象

- 双击 `ArmorVehicleDamageAssessment.UI.exe` 没有任何反应
- 程序没有启动，也没有错误提示
- 任务管理器中没有看到相关进程

## 🔍 快速诊断工具

我们提供了一个强大的诊断工具，可以自动检测常见问题：

```powershell
# 进入scripts目录
cd scripts

# 运行诊断工具
.\diagnose-startup.ps1

# 或指定应用程序路径
.\diagnose-startup.ps1 -AppPath "C:\path\to\your\app"
```

诊断工具会检查：
- ✅ 系统环境和.NET运行时
- ✅ 应用程序文件完整性
- ✅ 配置文件格式和内容
- ✅ 文件权限和进程启动
- ✅ Windows事件日志
- ✅ 应用程序日志文件

## 🛠️ 自动修复工具

发现问题后，使用自动修复工具：

```powershell
# 运行修复工具
.\fix-common-issues.ps1

# 强制修复所有配置
.\fix-common-issues.ps1 -Force
```

修复工具会自动：
- 🔧 修复损坏的配置文件
- 📁 创建缺失的目录结构
- 🔐 修复文件权限问题
- 📋 验证依赖文件完整性
- 🧪 测试程序启动能力

## 📋 手动排查步骤

### Step 1: 检查配置文件问题

#### 🔍 发现的主要问题
我发现你的配置文件中存在以下问题：

1. **数据库连接字符串为空**
   ```json
   // ❌ 原始配置 (有问题)
   "ConnectionStrings": {
     "DefaultConnection": ""
   }
   
   // ✅ 修复后的配置
   "ConnectionStrings": {
     "DefaultConnection": "Data Source=Data/ArmorVehicleAssessment.db;Cache=Shared;"
   }
   ```

2. **配置文件路径问题**
   - 程序启动时可能找不到 `appsettings.json`
   - NLog配置文件格式可能有误

#### 🛠️ 手动修复配置文件

创建正确的 `appsettings.json`：
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=Data/ArmorVehicleAssessment.db;Cache=Shared;"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "ArmorVehicleDamageAssessment": "Debug",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AppSettings": {
    "ApplicationName": "装甲车辆抗毁伤数字化评估软件平台",
    "Version": "1.0.0",
    "Organization": "沈阳理工大学",
    "DefaultPageSize": 20,
    "MaxPageSize": 100
  }
}
```

### Step 2: 检查系统环境

#### .NET 运行时检查
```cmd
# 检查已安装的.NET版本
dotnet --list-runtimes

# 检查SDK版本
dotnet --version
```

**需要的运行时**:
- 框架依赖版本：.NET 8.0 Runtime
- 自包含版本：无需额外安装

#### 下载.NET运行时
如果缺少.NET 8.0运行时：
- 下载地址：https://dotnet.microsoft.com/download/dotnet/8.0
- 选择 "Download .NET Runtime 8.0" (Windows x64)

### Step 3: 检查Windows事件日志

```cmd
# 打开事件查看器
eventvwr.msc
```

查看路径：`Windows日志 → 应用程序`，寻找：
- 来源包含 "ArmorVehicle" 的错误
- .NET Runtime 相关错误
- 应用程序崩溃记录

### Step 4: 检查应用程序日志

程序启动时会在以下位置创建详细日志：

```
应用程序目录/
├── logs/
│   ├── startup.log        # 启动过程日志
│   ├── error.log          # 错误详情日志
│   └── 2025-01-27.log     # 日常运行日志
```

**重要日志文件**：
- `startup.log` - 记录启动的每个步骤
- `error.log` - 包含详细的错误信息和堆栈跟踪

## 🚀 多种打包方式解决方案

如果配置修复后仍有问题，尝试不同的打包版本：

### 构建多个版本

使用我们的多版本构建脚本：

```powershell
# 构建所有版本
.\build-multiple-versions.ps1

# 清理后重新构建
.\build-multiple-versions.ps1 -CleanFirst
```

### 可用的打包版本

| 版本类型 | 特点 | 适用场景 |
|----------|------|----------|
| **SelfContained-Win10** | 包含运行时，适用Win10/11 | 🥇 首选，无需安装.NET |
| **SelfContained-Win7** | 兼容Win7的自包含版本 | 🔧 旧系统兼容 |
| **FrameworkDependent** | 需要.NET 8.0，体积小 | 💡 已安装.NET的环境 |
| **SingleFile** | 单文件版本，便于分发 | 📦 便携使用 |
| **Portable** | 便携版本 | 🎒 移动使用 |

### 推荐使用顺序

1. **SelfContained-Win10** (首选)
   - 包含所有依赖，无需安装.NET
   - 适用于Windows 10/11

2. **FrameworkDependent + .NET 8.0**
   - 体积小，启动快
   - 需要预装.NET 8.0运行时

3. **SelfContained-Win7**
   - 兼容性最好
   - 适用于旧系统

## 🔧 高级排查方法

### 使用Process Monitor

1. 下载安装 [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)
2. 启动Process Monitor
3. 尝试运行程序
4. 查看文件访问失败、注册表错误等

### 使用命令行启动

```cmd
# 命令行启动，查看错误信息
cd "程序目录"
ArmorVehicleDamageAssessment.UI.exe

# PowerShell启动
Start-Process -FilePath "ArmorVehicleDamageAssessment.UI.exe" -Wait
```

### 检查文件依赖

```cmd
# 使用Dependency Walker检查DLL依赖
# 下载: https://www.dependencywalker.com/
```

## 📞 具体解决方案

### 问题1: .NET运行时缺失

**现象**: 双击无反应，事件日志显示.NET相关错误

**解决方法**:
```bash
1. 下载安装.NET 8.0 Runtime
2. 或使用SelfContained版本
3. 验证: dotnet --list-runtimes
```

### 问题2: 配置文件错误

**现象**: 程序启动后立即退出

**解决方法**:
```bash
1. 运行: .\fix-common-issues.ps1
2. 手动修复appsettings.json
3. 检查logs/error.log文件
```

### 问题3: 权限问题

**现象**: 无权限访问文件或目录

**解决方法**:
```bash
1. 以管理员身份运行
2. 修改程序目录权限
3. 将程序移至用户目录
```

### 问题4: 杀毒软件拦截

**现象**: 程序被静默拦截

**解决方法**:
```bash
1. 临时关闭杀毒软件
2. 将程序添加到白名单
3. 查看杀毒软件日志
```

### 问题5: 系统兼容性

**现象**: 在某些Windows版本上无法运行

**解决方法**:
```bash
1. 使用SelfContained-Win7版本
2. 安装Visual C++ Redistributable
3. 更新Windows系统
```

## 🧪 验证修复效果

### 验证步骤

1. **文件完整性检查**
   ```powershell
   .\diagnose-startup.ps1 -Verbose
   ```

2. **配置正确性验证**
   ```powershell
   # 检查JSON格式
   Get-Content appsettings.json | ConvertFrom-Json
   ```

3. **启动测试**
   ```powershell
   # 使用启动脚本
   .\start.ps1
   
   # 或直接运行
   .\ArmorVehicleDamageAssessment.UI.exe
   ```

4. **功能验证**
   - 界面正常显示
   - 数据库连接成功
   - 日志正常记录

## 📞 技术支持

### 收集诊断信息

如果问题仍然存在，请收集以下信息：

1. **系统信息**
   ```cmd
   systeminfo > system-info.txt
   ```

2. **诊断报告**
   ```powershell
   .\diagnose-startup.ps1 -Verbose > diagnosis.txt
   ```

3. **应用程序日志**
   - logs/ 目录下的所有文件
   - Windows事件查看器截图

4. **错误截图**
   - 任何错误对话框
   - Process Monitor输出

### 联系信息

- **开发单位**: 沈阳理工大学
- **软件版本**: 1.0.0
- **技术支持**: 请提供上述诊断信息

## 📚 相关文档

- [运行说明](运行说明.md) - 完整运行指导
- [快速启动指南](快速启动指南.md) - 一分钟上手
- [项目README](../README.md) - 项目总览

---

*💡 提示：90%的启动问题都可以通过自动诊断和修复工具解决。如果问题复杂，请逐步按照本指南进行排查。*
